<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Wednesday, September 04, 2024, 10:51 AM -->
<!-- MuClient version 5.07-pre -->
<!-- Plugin "aard_tick_info" generated by Plugin Wizard -->

<muclient>
<plugin
   name="aard_tick_info"
   author="deathr"
   id="2ca22403f59264df05c62986"
   language="Lua"
   purpose="Provides information on next tick"
   date_written="2024-09-04 10:51:24"
   requires="5.07"
   version="1.0"
   >

</plugin>

    <aliases>
        <alias enabled="y" regexp="y" match="^next tick$" script="alias_next_tick" sequence="100" send_to="12"></alias>
    </aliases>


<script>
<![CDATA[
local plugin_id_gmcp_handler = "3e7dedbe37e44942dd46d264"

function OnPluginBroadcast(msg, id, name, text)
    if (id == plugin_id_gmcp_handler) then
        if (text == "comm.tick") then
            on_tick_update(gmcp("comm.tick"))
        end
    end
end

function gmcp(s)
    local ret, datastring = CallPlugin(plugin_id_gmcp_handler, "gmcpdata_as_string", s)
    pcall(loadstring("data = " .. datastring))
    return data
end

function OnPluginInstall()
    init_plugin()
end

function OnPluginConnect()
    init_plugin()
end

function OnPluginEnable()
    init_plugin()
end

function init_plugin()
    if not IsConnected() then
        return
    end

    ColourNote("#93c47d", "", "Enabled Aardwolf Tick Info Plugin")
    on_tick_update(gmcp("comm.tick"))
end

--
-- Tick methods
--

local avg_tick_time = 30
local last_tick = 0

function on_tick_update(tick)
    -- Example: {"ctime" : 1724411945, "time": "07:19:05 - Friday 23 Aug, 2024"}
    last_tick = tonumber(tick.ctime)
end

function time_to_next_tick()
    if last_tick == nil then
        return avg_tick_time
    end
    delta_time = ctime() - last_tick
    return avg_tick_time - delta_time
end

function alias_next_tick(name, line, wildcards)
    ColourNote("#93c47d", "", string.format("The next tick is in %d seconds", time_to_next_tick()))
end

function ctime()
    return GetInfo(304)
end

]]>
</script>

</muclient>
